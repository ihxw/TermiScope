#!/bin/bash
# TermiScope 监控代理卸载脚本

set -e

echo "========================================="
echo " TermiScope 监控代理卸载程序"
echo "========================================="
echo ""

# 检测操作系统
OS=$(uname -s | tr '[:upper:]' '[:lower:]')

# 设置变量
INSTALL_DIR="/opt/termiscope/agent"
SERVICE_NAME="termiscope-agent"

case $OS in
    linux)
        if command -v systemctl &> /dev/null; then
            INIT_SYSTEM="systemd"
            SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
        elif [ -f /etc/openwrt_release ]; then
            INIT_SYSTEM="procd"
            SERVICE_FILE="/etc/init.d/${SERVICE_NAME}"
        elif command -v initctl &> /dev/null; then
            INIT_SYSTEM="upstart"
            SERVICE_FILE="/etc/init/${SERVICE_NAME}.conf"
        elif [ -f /etc/rc.conf ]; then
            INIT_SYSTEM="freebsd"
            SERVICE_FILE="/usr/local/etc/rc.d/${SERVICE_NAME}"
            SERVICE_NAME="termiscope_agent" # FreeBSD uses underscore often, but let's check installed name
        else
            INIT_SYSTEM="sysv"
            SERVICE_FILE="/etc/init.d/${SERVICE_NAME}"
        fi
        ;;
    darwin)
        INSTALL_DIR="$HOME/Library/TermiScope/agent"
        SERVICE_FILE="$HOME/Library/LaunchAgents/com.termiscope.agent.plist"
        INIT_SYSTEM="launchd"
        ;;
    *)
        echo "错误: 不支持的操作系统 $OS"
        exit 1
        ;;
esac

echo "检测到系统: $OS"
echo "服务类型: $INIT_SYSTEM"
echo ""

# 停止并禁用服务
echo "[1/3] 停止服务..."
case $INIT_SYSTEM in
    systemd)
        if systemctl is-active --quiet $SERVICE_NAME 2>/dev/null; then
            sudo systemctl stop $SERVICE_NAME
        fi
        sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
        ;;
    procd)
        if [ -f "$SERVICE_FILE" ]; then
            $SERVICE_FILE stop || true
            $SERVICE_FILE disable || true
        fi
        ;;
    upstart)
        sudo initctl stop $SERVICE_NAME 2>/dev/null || true
        ;;
    freebsd)
        sudo service $SERVICE_NAME stop 2>/dev/null || true
        # FreeBSD disable is typically removing from rc.conf or setting to NO
        sudo sysrc ${SERVICE_NAME}_enable=NO 2>/dev/null || true
        ;;
    sysv)
        if [ -f "$SERVICE_FILE" ]; then
            sudo $SERVICE_FILE stop || true
            # update-rc.d or chkconfig to disable
            if command -v update-rc.d &> /dev/null; then
                sudo update-rc.d -f $SERVICE_NAME remove
            elif command -v chkconfig &> /dev/null; then
                sudo chkconfig $SERVICE_NAME off
                sudo chkconfig --del $SERVICE_NAME
            fi
        fi
        ;;
    launchd)
        launchctl unload $SERVICE_FILE 2>/dev/null || true
        ;;
esac

# 删除服务文件
echo "[2/3] 删除服务配置..."
if [ -f "$SERVICE_FILE" ]; then
    if [ "$OS" = "darwin" ]; then
        rm -f "$SERVICE_FILE"
    else
        sudo rm -f "$SERVICE_FILE"
    fi
fi

# systemd reload
if [ "$INIT_SYSTEM" = "systemd" ]; then
    sudo systemctl daemon-reload
fi

# 删除文件
echo "[3/3] 删除程序文件..."
if [ -d "$INSTALL_DIR" ]; then
    if [ "$OS" = "darwin" ]; then
        rm -rf "$INSTALL_DIR"
    else
        sudo rm -rf "$INSTALL_DIR"
    fi
fi

# 通知服务器卸载完成
echo "[4/4] 通知服务器..."
CALLBACK_URL="{{SERVER_URL}}/api/monitor/uninstall/callback?secret={{SECRET}}&host_id={{HOST_ID}}"
http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$CALLBACK_URL")

if [ "$http_code" -eq 200 ]; then
    echo "✓ 服务器状态已更新"
else
    echo "! 警告: 无法通知服务器更新状态 (HTTP $http_code)"
fi

echo ""
echo "========================================="
echo " 卸载完成！"
echo "========================================="
